name: Build and Test Docker Image

on:
  pull_request:
    branches:
      - master
  # push는 deploy.yml에서 처리 (test + deploy 함께 실행)

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t inklings-server:test .
          echo "✅ Docker image built successfully"

      - name: Test container with real PostgreSQL
        run: |
          # 컨테이너 시작 (host network로 PostgreSQL 접근)
          docker run -d --name test-container \
            --network host \
            -e DATABASE_URL=postgres://test_user:test_pass@localhost:5432/test_db \
            -e SERVER_HOST=127.0.0.1 \
            -e SERVER_PORT=8080 \
            -e RUST_LOG=info \
            inklings-server:test

          # 10초 대기 (DB 연결 + 서버 시작)
          echo "Waiting for server to start..."
          sleep 10

          # 컨테이너 로그 확인
          echo "=== Container Logs ==="
          docker logs test-container

          # 컨테이너 상태 확인
          echo "=== Container Status ==="
          if docker ps | grep test-container | grep -q "Up"; then
            echo "✅ Container is running"
          else
            echo "❌ Container failed to start"
            docker logs test-container
            exit 1
          fi

      - name: Test health endpoint
        run: |
          # 헬스체크 엔드포인트 호출
          echo "Testing health endpoint..."
          response=$(curl -s http://localhost:8080/ || echo "failed")
          echo "Response: $response"

          if echo "$response" | grep -q "ok"; then
            echo "✅ Health check passed"
          else
            echo "❌ Health check failed"
            docker logs test-container
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          docker stop test-container || true
          docker rm test-container || true
